# 内核调优

### 1. **瓶颈导向原则**

调优前必须通过`top/htop`、`ss/netstat`（查看网络状态）、`vmstat`,`iostat`(查看整体状态)等工具确定真实瓶颈（CPU/内存/磁盘I/O/网络I/O），避免盲目修改。

sar 命令，sar 的最大优势在于持久化历史数据：默认每 10 分钟采集一次，保存到 /var/log/sa/（或 /var/log/sysstat/）目录下，可回顾过去几天甚至几个月的数据。

### 2. **渐进式与可逆性**

- **小步快跑**：每次仅调整1-2个参数，观察影响
- **配置备份**：修改前备份原始配置，确保可回滚
- **灰度验证**：先在测试环境验证，再生产部署

### 3. **场景化定制**

不同应用场景参数差异巨大：

- **高并发Web**：优化TCP连接队列、端口复用
- **数据库/缓存**：降低swap倾向，优化脏页策略
- **大数据/文件服务**：调整I/O调度器、预读策略

#### **规划调优参数**

根据瓶颈选择参数。常见类别及示例（适用于 RHEL/CentOS/Ubuntu 等）：

| 类别           | 常见参数                                   | 典型场景与建议值                        | 说明         |
| -------------- | ------------------------------------------ | --------------------------------------- | ------------ |
| **网络**       | net.core.somaxconn                         | 高并发 Web：4096 或更高                 | 监听队列长度 |
|                | net.ipv4.tcp_max_syn_backlog               | 防 SYN 攻击：4096–8192                  | SYN 队列     |
|                | net.ipv4.tcp_tw_reuse                      | TIME_WAIT 多：1（启用）                 | 端口重用     |
| **内存**       | vm.swappiness                              | 数据库/应用服务器：1–10（低值减少换出） | 交换倾向     |
|                | vm.dirty_ratio / vm.dirty_background_ratio | IO 密集：5–10 / 2–5                     | 脏页回写比例 |
|                | vm.overcommit_memory                       | 内存超卖场景：1                         | 允许过量分配 |
| **文件描述符** | fs.file-max                                | 高并发连接：1048576                     | 系统级最大   |
| **其他**       | kernel.sem                                 | 信号量限制：调整为更大值                | 进程通信     |

### **Sysctl内核参数调优（最常用）**



通过`sysctl`命令调整运行时参数，并通过`/etc/sysctl.d/`下的配置文件实现持久化

```bash
# 常用操作
sysctl -a | grep tcp_          # 查看当前参数
sysctl -w net.core.somaxconn=65535  # 临时生效
echo "net.core.somaxconn = 65535" >> /etc/sysctl.d/99-performance.conf
sysctl -p /etc/sysctl.d/99-performance.conf  # 加载配置
```

## 调优实施流程（例子）

```bash
# Step 1: 基线评估（调优前）
sar -u -r -d -n DEV 1 10 > baseline.log

# Step 2: 创建独立配置文件
cat > /etc/sysctl.d/99-custom.conf << 'EOF'
# 根据上述表格填入适合场景的参数
net.core.somaxconn = 65535
vm.swappiness = 10
EOF

# Step 3: 应用并验证
sysctl -p /etc/sysctl.d/99-custom.conf
sysctl net.core.somaxconn  # 确认生效

# Step 4: 监控验证（关键）
dmesg | tail -20           # 检查内核错误
ss -s                      # 观察连接状态变化
vmstat 1 10                # 观察内存、I/O变化
```

### dd 命令知识点总结

`dd`（data duplicator）是 Linux 系统中的低级数据复制和转换工具，用于字节级数据处理，常应用于磁盘映像创建、备份和填充。

- **核心功能**：从输入源精确复制数据到输出目标，支持块级操作。
- **基本语法**：`dd if=输入源 of=输出目标 [选项]`。
- **关键选项**：
  - `if=`：输入文件（如 `/dev/zero` 用于生成零字节）。
  - `of=`：输出文件或设备。
  - `bs=`：块大小（例如 `1M` 表示 1 MiB，提高效率）。
  - `count=`：复制块数量（控制总大小）。
  - `status=progress`：显示进度（现代版本支持）。
- **常见用途**：
  - 创建固定大小文件：`dd if=/dev/zero of=file.img bs=1M count=1024`（创建 1 GiB 全零文件）。
  - 磁盘备份/克隆：`dd if=/dev/sda of=backup.img`。
  - 数据擦除：填充 `/dev/zero` 或 `/dev/urandom`。
- **注意事项**：操作需谨慎（root 权限），错误可能导致数据丢失；备选工具如 `fallocate` 或 `truncate` 用于快速分配空间。

### Loop 设备知识点总结

Loop 设备（loop device）是 Linux 内核的虚拟块设备，用于将普通文件模拟为块设备（如磁盘分区）。

- **核心功能**：桥接文件与块设备接口，实现镜像挂载和虚拟磁盘操作。
- **设备路径**：`/dev/loopX`（X 为数字，动态分配）。
- **关联工具**：`losetup`（设置/查看/解除关联）。
- **关键命令**：
  - 关联：`losetup -fP file.img`（-f 自动选择，-P 支持分区）。
  - 查看：`losetup -l`。
  - 解除：`losetup -d /dev/loopX`。
  - 直接挂载：`mount -o loop file.iso /mnt`。
- **常见用途**：
  - 挂载镜像（如 ISO 文件）。
  - 创建虚拟磁盘：结合 `dd` 生成文件后，用于测试、加密（LUKS）或容器环境。
  - 加密磁盘示例：dd 创建文件 → losetup 关联 → cryptsetup 初始化 LUKS → 格式化/挂载。
- **优势与意义**：提供硬件抽象，提升灵活性（无需物理设备）；支持加密、安全存储和虚拟化场景。
- **注意事项**：性能低于真实块设备；数量有限，可通过内核参数调整。

### 结合应用
`dd` 与 Loop 设备常配合使用：先用 `dd` 创建映像文件，再通过 Loop 设备挂载或加密，实现虚拟磁盘的全流程模拟。这在运维、开发测试和红帽认证实验中极为实用。